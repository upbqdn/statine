{{ define "main" }}
<article
  class="article h-entry body"
  itemprop="mainEntity"
  itemscope
  itemtype="http://schema.org/BlogPosting"
  data-pagefind-body
>
  <div class="title-container">
    {{ if .Title}}
    <h1 class="page-title mt-12 mb-4" itemprop="name">
      <a href="{{ .Page.Permalink }}">{{ .Title }}</a>
    </h1>
    {{ end }} {{ if not .Params.notoc }} {{ with .TableOfContents }} {{ . }}
    {{end }} {{ end }} {{ if .Params.Headline }}
    <b
      ><i itemprop="headline" class="article-headline text-lg p-summary">
        {{ .Params.Headline }}
      </i></b
    >
    {{ end }} {{ if .Params.Readingtime }}
    <div>
      Reading time: {{ math.Round (div (countwords .Content) 220.0) }} minutes.
    </div>
    {{ end }}
  </div>
  <div
    class="article-content e-content"
    itemprop="articleBody"
    id="article-content"
  >
    {{ $c := .Content }}
    {{/* Wrap math in pagefind-ignore (for MathJax), add hidden searchable copy */}}
    {{ $c = replaceRE `\\\((.+?)\\\)` `<span data-pagefind-ignore>\($1\)</span><b hidden>$1</b>` $c }}
    {{ $c = replaceRE `(?s)\$\$(.+?)\$\$` `<span data-pagefind-ignore>$$$$${1}$$$$</span><b hidden>${1}</b>` $c }}
    {{/* Strip \commands from hidden spans (3 passes for nested commands) */}}
    {{ $c = replaceRE `(<b hidden>[^<\\]*)\\[a-zA-Z]+([^<]*</b>)` `$1$2` $c }}
    {{ $c = replaceRE `(<b hidden>[^<\\]*)\\[a-zA-Z]+([^<]*</b>)` `$1$2` $c }}
    {{ $c = replaceRE `(<b hidden>[^<\\]*)\\[a-zA-Z]+([^<]*</b>)` `$1$2` $c }}
    {{/* Strip braces from hidden spans (4 passes) */}}
    {{ $c = replaceRE `(<b hidden>[^<{}]*)[{}]([^<]*</b>)` `$1$2` $c }}
    {{ $c = replaceRE `(<b hidden>[^<{}]*)[{}]([^<]*</b>)` `$1$2` $c }}
    {{ $c = replaceRE `(<b hidden>[^<{}]*)[{}]([^<]*</b>)` `$1$2` $c }}
    {{ $c = replaceRE `(<b hidden>[^<{}]*)[{}]([^<]*</b>)` `$1$2` $c }}
    {{/* Strip sub/superscript markers */}}
    {{ $c = replaceRE `(<b hidden>[^<_^]*)[_^]([^<]*</b>)` `$1 $2` $c }}
    {{ $c = replaceRE `(<b hidden>[^<_^]*)[_^]([^<]*</b>)` `$1 $2` $c }}
    {{ partial "headline-hash.html" $c }}
  </div>
  <hr class="my-5 w-full border-t border-zinc-300 dark:border-fg-muted/30" />
  {{ if or .Params.tags .Params.Date }}{{ partial "taxonomy.html" . }}{{ end }}
  {{ if .Params.references }}
  <hr />
  <div class="mb-8">
    <h3>References</h3>
    <div class="references-list">
      <ol>
        {{ range $elem_index, $elem_val := .Params.references }}
        <li id="{{ $elem_val.id }}">
          <b>{{$elem_val.authors}}</b>. {{$elem_val.text}}
        </li>
        {{ end }}
      </ol>
    </div>
  </div>
  {{ end }}
  <div>
    <script>
      var remark_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
      localStorage.remark42_theme = remark_theme;
      var remark_config = {
        host: "https://remark42.marek.onl",
        site_id: "marek.onl",
        theme: remark_theme,
        show_email_subscription: true,
        simple_view: false,
        no_footer: true,
      };
      !(function (e, n) {
        for (var o = 0; o < e.length; o++) {
          var r = n.createElement("script"),
            c = ".js",
            d = n.head || n.body;
          "noModule" in r
            ? ((r.type = "module"), (c = ".mjs"))
            : (r.async = !0),
            (r.defer = !0),
            (r.src = remark_config.host + "/web/" + e[o] + c),
            d.appendChild(r);
        }
      })(remark_config.components || ["embed"], document);
    </script>
    <div id="remark42"></div>
  </div>
</article>
{{ end }}
